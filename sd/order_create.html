<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>주문관리 > 주문등록</title>

  <link rel="stylesheet" href="../common.css">
  <script defer src="../common.js"></script>

  <style>
    .titlebar{
      background:#1f6fb2;
      color:#fff;
      padding:18px 18px;
      border-radius:14px;
      box-shadow:0 8px 18px rgba(0,0,0,.06);
      margin-bottom:12px;
      font-weight:900;
      letter-spacing:-.2px;
    }
    .titlebar .crumb{ font-size:18px; }

    .tabs{
      display:flex;
      gap:10px;
      align-items:center;
      border-bottom:1px solid #e6ebf2;
      padding:0 6px 10px;
      margin-bottom:14px;
    }
    .tab{
      padding:10px 14px;
      border-radius:12px;
      cursor:pointer;
      font-weight:900;
      font-size:14px;
      color:#6b7280;
      user-select:none;
    }
    .tab.active{
      background:#eef6ff;
      color:#155a93;
      border:1px solid #d7e8ff;
    }

    /* form */
    .form{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px 18px;
      align-items:start;
    }
    .field{
      display:grid;
      grid-template-columns: 160px 1fr;
      gap:10px;
      align-items:center;
      min-height:38px;
    }
    .label{
      font-weight:900;
      font-size:13px;
      color:#111;
      white-space:nowrap;
    }
    .req::after{ content:" *"; color:#e11d48; font-weight:900; }
    .ctl{
      height:36px;
      border:1px solid #d8dee6;
      border-radius:10px;
      padding:0 10px;
      background:#fff;
      font-size:13px;
      outline:none;
      width:100%;
    }
    textarea.ctl{
      height:auto;
      min-height:92px;
      padding:10px;
      resize:vertical;
    }

    .row{
      display:flex; gap:10px; align-items:center;
    }
    .row .ctl{ flex:1; }
    .mini-btn{
      height:36px;
      min-width:42px;
      border-radius:10px;
      border:1px solid #cfe0f5;
      background:#fff;
      cursor:pointer;
      font-weight:900;
    }
    .mini-btn:hover{ background:#f6fbff; }

    .split{
      grid-column:1 / -1;
      border-top:1px solid #eef2f7;
      margin:6px 0;
    }

    .checkline{
      grid-column:1 / -1;
      display:flex;
      align-items:center;
      gap:10px;
      padding:6px 0;
      color:#374151;
      font-weight:800;
      font-size:13px;
    }

    .radio-line{
      display:flex;
      gap:18px;
      align-items:center;
      font-size:13px;
      font-weight:800;
      color:#374151;
      flex-wrap:wrap;
    }
    .radio-line label{ display:flex; align-items:center; gap:8px; }

    .actions{
      display:flex;
      justify-content:space-between;
      gap:10px;
      margin-top:14px;
    }
    .btn{
      height:36px;
      padding:0 14px;
      border-radius:10px;
      font-weight:900;
      font-size:13px;
      cursor:pointer;
      border:1px solid transparent;
      white-space:nowrap;
    }
    .btn.primary{ background:#1f6fb2; color:#fff; border-color:#1f6fb2; }
    .btn.primary:hover{ filter:brightness(.95); }
    .btn.ghost{ background:#fff; color:#1f6fb2; border-color:#cfe0f5; }
    .btn.ghost:hover{ background:#f6fbff; }
    .btn.success{ background:#18a058; color:#fff; border-color:#18a058; }
    .btn.success:hover{ filter:brightness(.95); }

    /* Work tab layout */
    .work-layout{
      display:grid;
      grid-template-columns: 280px 1fr;
      gap:14px;
      align-items:start;
    }

    .work-side{
      border:1px solid #e6ebf2;
      border-radius:14px;
      background:#fff;
      overflow:hidden;
    }
    .work-side-head{
      padding:12px;
      border-bottom:1px solid #eef2f7;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .side-btn{
      height:42px;
      border-radius:10px;
      border:1px solid #bfe6f2;
      background:#14b8d4;
      color:#fff;
      cursor:pointer;
      font-weight:900;
      text-align:left;
      padding:0 12px;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .side-btn:hover{ filter:brightness(.96); }
    .plus{
      width:24px; height:24px; border-radius:999px;
      background:rgba(255,255,255,.25);
      display:grid; place-items:center;
      font-weight:900;
    }

    .work-list{
      padding:8px;
      max-height:520px;
      overflow:auto;
    }
    .work-item{
      border:1px solid #eef2f7;
      border-radius:12px;
      padding:10px 10px;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      margin-bottom:8px;
      background:#fff;
    }
    .work-item.active{
      border-color:#d7e8ff;
      background:#f5f8ff;
    }
    .work-item .name{
      font-weight:900;
      font-size:13px;
      color:#111;
      line-height:1.2;
    }
    .work-item .meta{
      font-size:12px;
      color:#6b7280;
      font-weight:800;
      margin-top:2px;
    }
    .del{
      width:28px; height:28px;
      border-radius:8px;
      border:1px solid #f2c2c7;
      background:#fff;
      cursor:pointer;
      display:grid;
      place-items:center;
      color:#e11d48;
      font-weight:900;
      flex:0 0 auto;
    }
    .del:hover{ background:#fff5f6; }

    .work-main{
      border:1px solid #e6ebf2;
      border-radius:14px;
      background:#fff;
      overflow:hidden;
    }
    .work-main-head{
      padding:12px 14px;
      border-bottom:1px solid #eef2f7;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .work-main-title{
      font-weight:900;
      font-size:14px;
      color:#111;
    }

    .work-main-body{
      padding:14px;
    }

    .work-form{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px 18px;
      align-items:start;
      margin-bottom:12px;
    }

    .grid-wrap{
      border:1px solid #e6ebf2;
      border-radius:14px;
      overflow:hidden;
      background:#fff;
      margin-top:10px;
    }
    table{
      width:100%;
      border-collapse:collapse;
    }
    thead th{
      background:#f7f9fc;
      font-weight:900;
      font-size:13px;
      padding:10px 10px;
      border-bottom:1px solid #eef2f7;
      text-align:left;
      white-space:nowrap;
    }
    tbody td{
      font-size:13px;
      padding:8px 10px;
      border-bottom:1px solid #eef2f7;
      vertical-align:middle;
    }
    tbody tr:hover{ background:#fafcff; }

    .cell-input{
      height:32px;
      border:1px solid #d8dee6;
      border-radius:10px;
      padding:0 8px;
      font-size:13px;
      width:100%;
      outline:none;
      background:#fff;
    }
    .amt{ text-align:right; font-variant-numeric: tabular-nums; }
    .tiny-btn{
      height:32px;
      padding:0 10px;
      border-radius:10px;
      border:1px solid #cfe0f5;
      background:#fff;
      cursor:pointer;
      font-weight:900;
      font-size:12px;
      white-space:nowrap;
    }
    .tiny-btn:hover{ background:#f6fbff; }

    .summary{
      display:grid;
      grid-template-columns: 1fr 220px;
      gap:10px 18px;
      margin-top:12px;
      align-items:start;
    }
    .sum-right{
      justify-self:end;
      width:260px;
      border:1px solid #eef2f7;
      border-radius:14px;
      padding:12px;
      background:#fbfdff;
    }
    .sum-row{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:6px 0;
      font-size:13px;
      font-weight:800;
      color:#374151;
    }
    .sum-row strong{ font-variant-numeric: tabular-nums; }
    .sum-row.total{
      border-top:1px solid #e6ebf2;
      margin-top:6px;
      padding-top:10px;
      color:#e11d48;
      font-weight:900;
    }

    .hidden{ display:none; }

    @media (max-width: 980px){
      .form{ grid-template-columns:1fr; }
      .field{ grid-template-columns: 140px 1fr; }
      .work-layout{ grid-template-columns:1fr; }
      .work-form{ grid-template-columns:1fr; }
      .sum-right{ width:100%; justify-self:stretch; }
    }
  </style>
</head>

<body>
<header class="topbar">
  <div class="topbar-inner">
    <div class="brand">
      <div class="logo">◎</div>
      <div>ERP UI</div>
    </div>

    <div id="nav-container"></div>

    <div class="userbox">H.Q / 안현모</div>
  </div>
</header>

<main class="app">
  <div class="titlebar">
    <div class="crumb">주문관리 &gt; 주문등록</div>
  </div>

  <section class="panel">
    <div class="panel-head">
      <div><div class="panel-title">주문등록</div></div>
    </div>

    <div class="panel-body">

      <!-- Tabs -->
      <div class="tabs">
        <div class="tab active" data-tab="order">주문정보</div>
        <div class="tab" data-tab="work">작업정보</div>
      </div>

      <!-- TAB 1: 주문정보 -->
      <div id="tab-order">
        <div class="form">
          <div class="field">
            <div class="label">접수자</div>
            <input class="ctl" value="안현모" disabled />
          </div>

          <div class="field">
            <div class="label req">완료요청일시</div>
            <input class="ctl" type="datetime-local" value="2026-02-05T16:00" />
          </div>

          <div class="field">
            <div class="label req">접수일자</div>
            <input class="ctl" type="date" value="2026-02-02" />
          </div>

          <div class="field">
            <div class="label req">고객명</div>
            <div class="row">
              <input class="ctl" placeholder="고객명으로 검색 후 선택" />
              <button class="mini-btn" type="button" onclick="alert('프로토타입: 고객 검색(미정)')">≡</button>
            </div>
          </div>

          <div class="field">
            <div class="label req">회사명</div>
            <div class="row">
              <input class="ctl" placeholder="회사명으로 검색 후 선택" />
              <button class="mini-btn" type="button" onclick="alert('프로토타입: 회사 검색(미정)')">≡</button>
            </div>
          </div>

          <div class="field">
            <div class="label">연락처</div>
            <input class="ctl" placeholder="연락처" />
          </div>

          <div class="field">
            <div class="label">이메일</div>
            <input class="ctl" placeholder="이메일" />
          </div>

          <div class="field">
            <div class="label"> </div>
            <div class="checkline">
              <input id="same" type="checkbox" />
              <label for="same">주문고객 정보와 동일합니다</label>
            </div>
          </div>

          <div class="split"></div>

          <div class="field">
            <div class="label req">수취인명</div>
            <input class="ctl" placeholder="수취인명" />
          </div>

          <div class="field">
            <div class="label req">수취인 연락처</div>
            <input class="ctl" placeholder="수취인 연락처" />
          </div>

          <div class="field" style="grid-column:1 / -1;">
            <div class="label">주소</div>
            <div style="width:100%;">
              <div class="row" style="margin-bottom:8px;">
                <input class="ctl" style="max-width:180px;" placeholder="우편번호" />
                <button class="btn ghost" type="button" style="height:36px;" onclick="alert('프로토타입: 주소검색(미정)')">주소검색</button>
              </div>
              <div class="row">
                <input class="ctl" placeholder="주소" />
                <input class="ctl" placeholder="나머지 주소" />
              </div>
            </div>
          </div>

          <div class="field">
            <div class="label">작업분류</div>
            <button class="btn ghost" type="button" onclick="alert('프로토타입: 작업분류 선택(미정)')">선택</button>
          </div>

          <div class="field">
            <div class="label">별도 사업본부 매출</div>
            <select class="ctl">
              <option>그래픽스사업본부</option>
              <option>패키지사업본부</option>
              <option>실사사업본부</option>
            </select>
          </div>

          <div class="field" style="grid-column:1 / -1;">
            <div class="label">특이사항</div>
            <textarea class="ctl" placeholder="특이사항"></textarea>
          </div>

          <div class="field" style="grid-column:1 / -1;">
            <div class="label req">결제방식</div>
            <div class="radio-line">
              <label><input type="radio" name="pay" checked> 외상</label>
              <label><input type="radio" name="pay"> 결제(현금/카드/무통장/무선카드)</label>
            </div>
          </div>
        </div>

        <div class="actions">
          <div>
            <button class="btn ghost" type="button" onclick="history.back()">이전</button>
          </div>
          <div style="display:flex; gap:10px;">
            <button class="btn primary" type="button" id="goWork">다음</button>
            <button class="btn success" type="button" onclick="alert('프로토타입: 등록(미정)')">등록</button>
          </div>
        </div>
      </div>

      <!-- TAB 2: 작업정보 -->
      <div id="tab-work" class="hidden">
        <div class="work-layout">

          <!-- Left: 작업 목록/추가 -->
          <aside class="work-side">
            <div class="work-side-head">
              <button class="side-btn" type="button" id="btnAddWork"><span class="plus">＋</span> 작업추가</button>
              <button class="side-btn" type="button" onclick="alert('프로토타입: 실사 작업추가(미정)')"><span class="plus">＋</span> 실사 작업추가</button>
              <button class="side-btn" type="button" onclick="alert('프로토타입: 명함 작업추가(미정)')"><span class="plus">＋</span> 명함 작업추가</button>
              <button class="side-btn" type="button" onclick="alert('프로토타입: 디자인 등록(미정)')"><span class="plus">＋</span> 디자인 등록</button>
            </div>

            <div class="work-list" id="workList"></div>
          </aside>

          <!-- Right: 작업 상세 -->
          <section class="work-main">
            <div class="work-main-head">
              <div class="work-main-title" id="workTitle">작업 상세</div>
              <div style="display:flex; gap:8px;">
                <button class="tiny-btn" type="button" id="btnAddItem">품목행 추가</button>
                <button class="tiny-btn" type="button" id="btnClearItems">품목 초기화</button>
              </div>
            </div>

            <div class="work-main-body">

              <div class="work-form">
                <div class="field">
                  <div class="label">외부생산</div>
                  <label style="font-weight:900; font-size:13px;">
                    <input type="checkbox" id="isOut"> 외부생산
                  </label>
                </div>

                <div class="field">
                  <div class="label req">제작부수(B)</div>
                  <div class="row">
                    <input class="ctl" id="qtyB" type="number" min="1" value="1" />
                    <div style="font-weight:900; color:#374151;">부</div>
                  </div>
                </div>

                <div class="field">
                  <div class="label req">작업명</div>
                  <input class="ctl" id="workName" placeholder="작업명" />
                </div>

                <div class="field">
                  <div class="label req">인쇄방향</div>
                  <div class="radio-line">
                    <label><input type="radio" name="dir" checked> 머리-머리</label>
                    <label><input type="radio" name="dir"> 머리-꼬리</label>
                  </div>
                </div>

                <div class="field">
                  <div class="label req">제작용지</div>
                  <select class="ctl" id="paper">
                    <option>A4(210mm X 297mm)</option>
                    <option>A3(297mm X 420mm)</option>
                    <option>명함(90mm X 50mm)</option>
                  </select>
                </div>

                <div class="field">
                  <div class="label">파일첨부</div>
                  <input class="ctl" type="file" />
                </div>

                <div class="field" style="grid-column:1 / -1;">
                  <div class="label">기타사항</div>
                  <textarea class="ctl" id="workMemo" placeholder="기타사항"></textarea>
                </div>
              </div>

              <!-- Items table -->
              <div class="grid-wrap">
                <table aria-label="품목 그리드">
                  <thead>
                    <tr>
                      <th style="width:130px;">품목</th>
                      <th>품목명</th>
                      <th style="width:110px;">수량(a)</th>
                      <th style="width:110px;">단가(b)</th>
                      <th style="width:140px;">소계(a×b)</th>
                      <th style="width:90px;">관리</th>
                    </tr>
                  </thead>
                  <tbody id="itemBody"></tbody>
                </table>
              </div>

              <!-- Summary -->
              <div class="summary">
                <div></div>
                <div class="sum-right">
                  <div class="sum-row">
                    <span>작업금액(C=A×B)</span>
                    <strong id="sumWork">0원</strong>
                  </div>
                  <div class="sum-row">
                    <span>배송비(E)</span>
                    <strong id="sumShip">0원</strong>
                  </div>
                  <div class="sum-row">
                    <span>할인(H)</span>
                    <strong id="sumDisc">0원</strong>
                  </div>
                  <div class="sum-row total">
                    <span>결제금액(G-H)</span>
                    <strong id="sumPay">0원</strong>
                  </div>
                </div>
              </div>

              <div class="actions">
                <div>
                  <button class="btn ghost" type="button" id="backOrder">이전</button>
                </div>
                <div style="display:flex; gap:10px;">
                  <button class="btn success" type="button" onclick="alert('프로토타입: 등록(미정)')">등록</button>
                </div>
              </div>

            </div>
          </section>

        </div>
      </div>

    </div>
  </section>
</main>

<script>
  // ===== Tabs =====
  const tabs = document.querySelectorAll(".tab");
  const tabOrder = document.getElementById("tab-order");
  const tabWork  = document.getElementById("tab-work");

  function openTab(name){
    tabs.forEach(t => t.classList.toggle("active", t.dataset.tab === name));
    tabOrder.classList.toggle("hidden", name !== "order");
    tabWork.classList.toggle("hidden", name !== "work");
  }
  tabs.forEach(t => t.addEventListener("click", () => openTab(t.dataset.tab)));
  document.getElementById("goWork").addEventListener("click", () => openTab("work"));
  document.getElementById("backOrder").addEventListener("click", () => openTab("order"));

  // ===== Work items (N개) =====
  const workListEl = document.getElementById("workList");
  const workTitleEl = document.getElementById("workTitle");
  const workNameEl = document.getElementById("workName");
  const workMemoEl = document.getElementById("workMemo");
  const qtyBEl = document.getElementById("qtyB");

  const itemBody = document.getElementById("itemBody");

  const sumWork = document.getElementById("sumWork");
  const sumShip = document.getElementById("sumShip");
  const sumDisc = document.getElementById("sumDisc");
  const sumPay  = document.getElementById("sumPay");

  const money = (n) => (Math.round(n)).toLocaleString("ko-KR") + "원";

  let works = [
    { id: 1, name: "작업 #1", memo:"", qtyB: 1, items: [
      { code:"", name:"", qtyA: 1, priceB: 0 }
    ], ship:0, disc:0 }
  ];
  let currentWorkId = 1;

  function currentWork(){
    return works.find(w => w.id === currentWorkId);
  }

  function renderWorkList(){
    workListEl.innerHTML = "";
    works.forEach(w => {
      const div = document.createElement("div");
      div.className = "work-item" + (w.id === currentWorkId ? " active" : "");
      div.innerHTML = `
        <div style="min-width:0;">
          <div class="name">${escapeHtml(w.name || ("작업 #" + w.id))}</div>
          <div class="meta">품목 ${w.items.length}개 · 부수 ${w.qtyB || 1}</div>
        </div>
        <button class="del" title="삭제">×</button>
      `;
      div.addEventListener("click", (e) => {
        if (e.target.closest(".del")) return;
        currentWorkId = w.id;
        renderAll();
      });
      div.querySelector(".del").addEventListener("click", (e) => {
        e.stopPropagation();
        if (works.length === 1) { alert("최소 1개의 작업은 필요합니다."); return; }
        works = works.filter(x => x.id !== w.id);
        if (currentWorkId === w.id) currentWorkId = works[0].id;
        renderAll();
      });
      workListEl.appendChild(div);
    });
  }

  function renderWorkDetail(){
    const w = currentWork();
    workTitleEl.textContent = `작업 상세 · ${w.name}`;
    workNameEl.value = w.name;
    workMemoEl.value = w.memo || "";
    qtyBEl.value = w.qtyB || 1;

    // items
    itemBody.innerHTML = "";
    w.items.forEach((it, idx) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td><input class="cell-input" value="${escapeAttr(it.code||"")}" placeholder="품목"></td>
        <td><input class="cell-input" value="${escapeAttr(it.name||"")}" placeholder="품목명"></td>
        <td><input class="cell-input amt" type="number" min="0" value="${it.qtyA ?? 0}"></td>
        <td><input class="cell-input amt" type="number" min="0" value="${it.priceB ?? 0}"></td>
        <td class="amt" data-sub="1">0</td>
        <td><button class="tiny-btn" type="button">삭제</button></td>
      `;

      const inputs = tr.querySelectorAll("input");
      const qtyInput = inputs[2];
      const priceInput = inputs[3];
      const subTd = tr.querySelector("[data-sub]");

      function recalcRow(){
        const a = Number(qtyInput.value || 0);
        const b = Number(priceInput.value || 0);
        subTd.textContent = money(a * b);
        recalcSummary();
      }

      // bind changes
      inputs[0].addEventListener("input", () => { it.code = inputs[0].value; });
      inputs[1].addEventListener("input", () => { it.name = inputs[1].value; });
      qtyInput.addEventListener("input", () => { it.qtyA = Number(qtyInput.value||0); recalcRow(); });
      priceInput.addEventListener("input", () => { it.priceB = Number(priceInput.value||0); recalcRow(); });

      tr.querySelector("button").addEventListener("click", () => {
        const ww = currentWork();
        if (ww.items.length === 1) { alert("품목은 최소 1개가 필요합니다."); return; }
        ww.items.splice(idx, 1);
        renderAll();
      });

      itemBody.appendChild(tr);
      recalcRow();
    });

    recalcSummary();
  }

  function recalcSummary(){
    const w = currentWork();
    const A = w.items.reduce((sum, it) => sum + (Number(it.qtyA||0) * Number(it.priceB||0)), 0);
    const B = Number(w.qtyB || 1);
    const C = A * B;

    const ship = Number(w.ship || 0);
    const disc = Number(w.disc || 0);
    const pay = Math.max(0, C + ship - disc);

    sumWork.textContent = money(C);
    sumShip.textContent = money(ship);
    sumDisc.textContent = money(disc);
    sumPay.textContent  = money(pay);
  }

  function renderAll(){
    renderWorkList();
    renderWorkDetail();
  }

  // Add work
  document.getElementById("btnAddWork").addEventListener("click", () => {
    const nextId = Math.max(...works.map(w => w.id)) + 1;
    works.push({
      id: nextId,
      name: `작업 #${nextId}`,
      memo: "",
      qtyB: 1,
      items: [{ code:"", name:"", qtyA: 1, priceB: 0 }],
      ship: 0,
      disc: 0
    });
    currentWorkId = nextId;
    renderAll();
  });

  // Work detail inputs -> current work sync
  workNameEl.addEventListener("input", () => { currentWork().name = workNameEl.value; renderWorkList(); workTitleEl.textContent = `작업 상세 · ${currentWork().name}`; });
  workMemoEl.addEventListener("input", () => { currentWork().memo = workMemoEl.value; });
  qtyBEl.addEventListener("input", () => { currentWork().qtyB = Math.max(1, Number(qtyBEl.value||1)); recalcSummary(); renderWorkList(); });

  // Item controls
  document.getElementById("btnAddItem").addEventListener("click", () => {
    currentWork().items.push({ code:"", name:"", qtyA: 1, priceB: 0 });
    renderWorkDetail();
    renderWorkList();
  });

  document.getElementById("btnClearItems").addEventListener("click", () => {
    currentWork().items = [{ code:"", name:"", qtyA: 1, priceB: 0 }];
    renderWorkDetail();
    renderWorkList();
  });

  // Start
  renderAll();

  // helpers
  function escapeHtml(s){
    return String(s ?? "").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }
  function escapeAttr(s){ return escapeHtml(s); }
</script>
</body>
</html>
